# Aria Art Plotter - Klipper Configuration
# Copyright (c) 2025 Gustavo Mayoral
#
# This file is part of the Aria Art Plotter project.
# 
# Hardware License: CERN Open Hardware Licence Version 2 - Strongly Reciprocal (CERN-OHL-S-2.0)
# Documentation License: Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)
# Software License: GNU General Public License v3.0 (GPL-3.0)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# Project: https://github.com/gustavomayoral/aria_art_plot
# Support: https://ko-fi.com/ariaartplot
# Web: https://aria-art.com

#####################################################################
# Probe Setup (MicroProbe configuration)
#####################################################################

[output_pin probe_enable]
pin: PC15
value: 0

[gcode_macro PROBE_DEPLOY]
gcode:
    SET_PIN PIN=probe_enable VALUE=1
    G4 P500  # Wait for probe to deploy

[gcode_macro PROBE_STOW]
gcode:
    SET_PIN PIN=probe_enable VALUE=0

[bed_mesh]
speed: 200                    
horizontal_move_z: 10         
mesh_min: 44, 6              
mesh_max: 480, 506           
probe_count: 9, 9
algorithm: bicubic
split_delta_z: 0.025
move_check_distance: 5.0
mesh_pps: 2,2
adaptive_margin: 5           

[probe]
pin: ^!PC13
x_offset: 39  
y_offset: 1   
z_offset: 0 
speed: 15.0
lift_speed: 30.0
samples: 1                   
samples_result: median       
sample_retract_dist: 1.5     
activate_gcode:
    PROBE_DEPLOY
deactivate_gcode:
    PROBE_STOW

# Auto-run startup sequence
[delayed_gcode aria_startup]
initial_duration: 4
gcode:
    ARIA_STARTUP_SEQUENCE

#####################################################################
# Dual Mesh System - Bed Surface vs Canvas Pressure
#####################################################################

[gcode_macro MESH_MANAGER]
description: Manage mesh selection between bed surface and canvas pressure
variable_selected_mesh: "bed_surface"        
variable_auto_load_on_home: 1
gcode:
    # This macro stores mesh management variables

[gcode_macro SELECT_BED_SURFACE_MESH]
description: Select bed surface mesh (default) as active mesh
gcode:
    SET_GCODE_VARIABLE MACRO=MESH_MANAGER VARIABLE=selected_mesh VALUE='"bed_surface"'
    
    RESPOND TYPE=command MSG="Loading bed surface mesh..."
    # Only show OLED during manual operation
    {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
        OLED_MESSAGE MSG="Loading bed\nsurface mesh..."
    {% endif %}
    
    # Check if mesh exists before loading
    {% if 'bed_surface' in printer.bed_mesh.profiles %}
        BED_MESH_PROFILE LOAD=bed_surface
        RESPOND TYPE=command MSG="Bed surface mesh loaded successfully"
        # Only show OLED during manual operation
        {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            OLED_MESSAGE MSG="Bed Surface\nMesh Active"
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="Bed surface mesh not found! Run CAL_FLAT first."
        # Only show OLED during manual operation
        {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            OLED_MESSAGE MSG="Error: No bed\nsurface mesh!"
        {% endif %}
    {% endif %}
    M117 Bed Surface Mesh

[gcode_macro SELECT_CANVAS_PRESSURE_MESH]
description: Select canvas pressure mesh (paraboloid) as active mesh
gcode:
    SET_GCODE_VARIABLE MACRO=MESH_MANAGER VARIABLE=selected_mesh VALUE='"canvas_pressure"'
    
    RESPOND TYPE=command MSG="Loading canvas pressure mesh..."
    # Only show OLED during manual operation
    {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
        OLED_MESSAGE MSG="Loading canvas\npressure mesh..."
    {% endif %}
    
    # Check if mesh exists before loading
    {% if 'canvas_pressure' in printer.bed_mesh.profiles %}
        BED_MESH_PROFILE LOAD=canvas_pressure
        RESPOND TYPE=command MSG="Canvas pressure mesh loaded successfully"
        # Only show OLED during manual operation
        {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            OLED_MESSAGE MSG="Canvas Pressure\nMesh Active"
        {% endif %}
    {% else %}
        RESPOND TYPE=error MSG="Canvas pressure mesh not found!"
        # Only show OLED during manual operation
        {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            OLED_MESSAGE MSG="Error: No canvas\nmesh!"
        {% endif %}
    {% endif %}
    M117 Canvas Pressure Mesh


[gcode_macro LOAD_SELECTED_MESH]
description: Load the currently selected mesh
gcode:
    {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
    
    {% if selected == "canvas_pressure" %}
        SELECT_CANVAS_PRESSURE_MESH
    {% else %}
        SELECT_BED_SURFACE_MESH
    {% endif %}

#####################################################################
# Enhanced G28 with mesh loading
#####################################################################

[gcode_macro G28]
rename_existing: G28.1
description: Enhanced homing with automatic mesh loading
gcode:
    # Only show OLED during manual operation
    {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
        OLED_MESSAGE MSG="Homing axes..."
    {% endif %}
    G28.1 {rawparams}
    
    {% set auto_load = printer["gcode_macro MESH_MANAGER"].auto_load_on_home|default(1) %}
    {% if auto_load %}
        LOAD_SELECTED_MESH
    {% endif %}

#####################################################################
# Basic Operation Macros with OLED Updates
#####################################################################

[gcode_macro LOAD_TOOL]
description: Tool loading at bed center with faster movement
variable_waiting_for_tool: 0
gcode:
    # Safety check: Don't allow during printing
    {% if printer.print_stats.state == "printing" %}
        RESPOND TYPE=error MSG="Cannot load tool during printing!"
        OLED_MESSAGE MSG="Error: Cannot\nload during print!"
        
    # Safety check: Don't allow if already waiting for tool
    {% elif printer["gcode_macro LOAD_TOOL"].waiting_for_tool %}
        RESPOND TYPE=error MSG="Already waiting for tool installation! Press TOOL LOADED."
        OLED_MESSAGE MSG="Press TOOL\nLOADED first!"
        
    {% else %}
        OLED_MESSAGE MSG="Tool Loading\nMode..."
        
        # Set waiting state to prevent printing
        SET_GCODE_VARIABLE MACRO=LOAD_TOOL VARIABLE=waiting_for_tool VALUE=1
        
        # Always home first to get to known position
        RESPOND TYPE=command MSG="Homing to establish reference..."
        G28                     
        
        # Clear mesh after homing
        RESPOND TYPE=command MSG="Clearing mesh compensation..."
        BED_MESH_CLEAR
        
        # Calculate bed center positions
        {% set center_x = 524 / 2 %}    # 262mm (bed center X)
        {% set center_y = 510 / 2 %}    # 255mm (bed center Y)
        
        # Move to bed center at faster speed, then down to tool loading position
        RESPOND TYPE=command MSG="Moving to bed center for tool loading..."
        G1 X{center_x} Y{center_y} F9000         
        G91                                       
        G1 Z-13.5 F9000                          
        G90                                       
        
        M117 Install Tool       
        OLED_MESSAGE MSG="Insert tool\nat bed center"
        RESPOND TYPE=command MSG="Tool loading at bed center X={center_x|round(1)}mm Y={center_y|round(1)}mm Z=27.5mm"
        RESPOND TYPE=command MSG="Install tool with 10mm puck for proper height"
        RESPOND TYPE=command MSG="When finished, press TOOL INSTALLED"
    {% endif %}

[gcode_macro TOOL_INSTALLED]
description: Confirm tool installation and set default pressure
gcode:
    # Safety check: Only allow if waiting for tool
    {% if not printer["gcode_macro LOAD_TOOL"].waiting_for_tool %}
        RESPOND TYPE=error MSG="No tool loading in progress! Run LOAD_TOOL first."
        OLED_MESSAGE MSG="Error: Run\nLOAD TOOL first!"
        
    {% else %}
        # Clear waiting state
        SET_GCODE_VARIABLE MACRO=LOAD_TOOL VARIABLE=waiting_for_tool VALUE=0
        
        # Store current Z position as tool reference
        {% set current_z = printer.toolhead.position.z %}
        SET_GCODE_VARIABLE MACRO=PEN_DOWN VARIABLE=tool_reference_z VALUE={current_z}
        
        # Set default pressure to Level 5 (+0.05mm, slightly light)
        SET_GCODE_VARIABLE MACRO=PEN_DOWN VARIABLE=pressure_offset VALUE=0.05
        SET_GCODE_VARIABLE MACRO=SET_PRESSURE_LEVEL VARIABLE=current_level VALUE=5
        
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        OLED_MESSAGE MSG="Tool confirmed\nPressure Level: 5\nMesh: {selected_mesh}"
        M117 Tool Ready
        
        # Move to start position
        G1 X5 Y5 F9000
        
        # Reactivate mesh compensation
        LOAD_SELECTED_MESH
        
        {% set surface_z = current_z - 10 %}
        RESPOND TYPE=command MSG="Tool ready. Reference Z={current_z|round(2)}mm stored."
        RESPOND TYPE=command MSG="Surface contact at Z={surface_z|round(2)}mm."
        RESPOND TYPE=command MSG="Default pressure set to Level 5 (+0.05mm)."
    {% endif %}

[gcode_macro TOOL_CHANGE_PAUSE]
description: Pause for manual tool change at tool loading height
gcode:
    {% set tool_name = params.TOOL|default("new tool")|string %}
    
    OLED_MESSAGE MSG="Tool Change\nRequired!"
    RESPOND TYPE=command MSG="=== TOOL CHANGE REQUIRED ==="
    RESPOND TYPE=command MSG="Next tool: {tool_name}"
    
    # Store current position for resume
    {% set current_x = printer.toolhead.position.x %}
    {% set current_y = printer.toolhead.position.y %}
    
    # Pause the print
    PAUSE_BASE
    
    # Clear mesh to prevent interference with tool change positioning
    BED_MESH_CLEAR
    
    # Move to bed center at tool loading height (same as LOAD_TOOL)
    {% set center_x = 524 / 2 %}    
    {% set center_y = 510 / 2 %}    

    RESPOND TYPE=command MSG="Moving to bed center for tool loading..."
  
    G28 Z
    
    G1 X{center_x} Y{center_y} F6000         
    G91                                       
    G1 Z-13.5 F9000                          
    G90                                       
    
    # Set default pressure to Level 5 (+0.05mm, slightly light)
    SET_GCODE_VARIABLE MACRO=PEN_DOWN VARIABLE=pressure_offset VALUE=0.05
    SET_GCODE_VARIABLE MACRO=SET_PRESSURE_LEVEL VARIABLE=current_level VALUE=5
    
    {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
    OLED_MESSAGE MSG="Tool confirmed\nPressure Level: 5\nMesh: {selected_mesh}"
    M117 Change Tool - Menu: Resume
    
    RESPOND TYPE=command MSG="1. Remove current tool"
    RESPOND TYPE=command MSG="2. Install {tool_name} with 10mm puck at Level 5 (+0.05mm)"
    RESPOND TYPE=command MSG="3. Use menu: Main > Resume"
    RESPOND TYPE=command MSG="Print will continue from X={current_x|round(1)} Y={current_y|round(1)}"

[gcode_macro RESUME]
rename_existing: RESUME_BASE
description: Resume print after tool change with proper setup
gcode:
    OLED_MESSAGE MSG="Confirming tool\ninstallation..."
    {% set current_z = printer.toolhead.position.z %}
    SET_GCODE_VARIABLE MACRO=PEN_DOWN VARIABLE=tool_reference_z VALUE={current_z}
    RESPOND TYPE=command MSG="New tool reference Z={current_z|round(2)}mm stored"
    LOAD_SELECTED_MESH
    RESUME_BASE
    
    {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
    {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
    OLED_MESSAGE MSG="Printing\nMesh: {selected}\nLevel: {level}"
    M117 Printing...
    RESPOND TYPE=command MSG="Print resumed - drawing with new tool at stored pressure"

#####################################################################
# Print Start Macros
#####################################################################


[gcode_macro PRINT_START]
description: Safely start printing a file with tool/mesh checks and preparations
gcode:
    RESPOND TYPE=command MSG="Starting print preparation..."
    
    # Check if waiting for tool installation
    {% set waiting = printer["gcode_macro LOAD_TOOL"].waiting_for_tool|default(0) %}
    {% if waiting %}
        CANCEL_PRINT
        TOOL_INSTALLED
        RESPOND TYPE=error MSG="Can not print. Run LOAD_TOOL AND TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Complete\ntool installation!"
        M117 Complete Tool Install
        
    {% else %}
        # FIRST THING: Reset velocity limits 
        SET_VELOCITY_LIMIT VELOCITY=400 ACCEL=1500 ACCEL_TO_DECEL=750 SQUARE_CORNER_VELOCITY=3.0
        M220 S100
        RESPOND TYPE=command MSG="Speed limits reset: 400mm/s max velocity"
        
        # Check if tool is loaded (handle empty variable)
        {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
        {% if tool_ref == 0.0 %}
            CANCEL_PRINT
            RESPOND TYPE=error MSG="Tool not loaded. Run LOAD_TOOL and TOOL_INSTALLED first."
            OLED_MESSAGE MSG="Load tool first.\nRun Change Tool\nGCODE at end layer."
            M117 Load Tool First
            
        {% else %}
            # Home if not fully homed
            {% if "xyz" not in printer.toolhead.homed_axes %}
                G28 F9000
            {% endif %}
            
            # Ensure mesh is loaded
            {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
            {% if printer.bed_mesh.profile_name == "" %}
                RESPOND TYPE=command MSG="No mesh loaded. Loading {selected}..."
                LOAD_SELECTED_MESH
            {% endif %}
            
            OLED_MESSAGE MSG="Preparing\nprint job..."
            
            # Move to drawing height and start position
            G91
            G1 Z-5 F9000
            G90
            G1 X5 Y5 F9000         
            
            {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
            {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
            OLED_MESSAGE MSG="Printing\nMesh: {selected}\nLevel: {level}"
            M117 Printing...
            RESPOND TYPE=command MSG="Print started successfully"
        {% endif %}
    {% endif %}


[gcode_macro PRINT_END]
description: End printing procedure
gcode:
    OLED_MESSAGE MSG="Finishing\nprint job..."
    RESPOND TYPE=command MSG="Finishing print..."
    PEN_UP                  
    G1 X0 Y0 F9000          
    M117 Print Complete     
    OLED_MESSAGE MSG="Print Complete!\nRemove artwork"
    RESPOND TYPE=command MSG="Print complete. Tool can now be removed."

# Legacy compatibility - redirect old names to new ones
[gcode_macro START_PRINT]
description: Legacy compatibility - redirects to PRINT_START
gcode:
    PRINT_START

[gcode_macro END_PRINT]
description: Legacy compatibility - redirects to PRINT_END  
gcode:
    PRINT_END

#####################################################################
# Menu Print Start Macro - CRITICAL FOR PLOTTER MENU PRINTING
#####################################################################

[gcode_macro PRINT_START_FROM_MENU]
description: Start printing the currently selected file from plotter menu
gcode:
    {% if not printer.virtual_sdcard.file_path %}
        RESPOND TYPE=error MSG="No file selected! Use Print > Select File first."
        OLED_MESSAGE MSG="Error: No file\nselected!"
        M117 No File Selected
    {% else %}
        {% set filename = printer.virtual_sdcard.file_path %}
        RESPOND TYPE=command MSG="Starting print from menu: {filename}"
        
        # Check if waiting for tool installation
        {% set waiting = printer["gcode_macro LOAD_TOOL"].waiting_for_tool|default(0) %}
        {% if waiting %}
            RESPOND TYPE=error MSG="Tool installation pending! Press TOOL INSTALLED first."
            OLED_MESSAGE MSG="Error: Complete\ntool installation!"
            M117 Complete Tool Install
        {% else %}
            # Check if tool is loaded (handle empty variable)
            {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
            {% if tool_ref == 0.0 %}
                RESPOND TYPE=error MSG="Tool not loaded! Run LOAD_TOOL and TOOL_INSTALLED first."
                OLED_MESSAGE MSG="Error: Load tool\nfirst!"
                M117 Load Tool First
            {% else %}
                # Home if not fully homed
                {% if "xyz" not in printer.toolhead.homed_axes %}
                    G28 F9000
                {% endif %}
                
                # Ensure mesh is loaded
                {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
                {% if printer.bed_mesh.profile_name == "" %}
                    RESPOND TYPE=command MSG="No mesh loaded. Loading {selected}..."
                    LOAD_SELECTED_MESH
                {% endif %}
                
                # Set safe speed limits for pen plotting
                #SET_VELOCITY_LIMIT VELOCITY=50 ACCEL=500 ACCEL_TO_DECEL=250 SQUARE_CORNER_VELOCITY=3
                #RESPOND TYPE=command MSG="Safe speeds set: 50mm/s max velocity, 500mm/sÂ² accel."
                
                # Run PRINT_START for additional prep
                PRINT_START
                
                # **CRITICAL: Actually start the selected file!**
                SDCARD_PRINT_FILE FILENAME="{filename}"
                RESPOND TYPE=command MSG="Print started from menu: {filename}"
            {% endif %}
        {% endif %}
    {% endif %}

#####################################################################
# Pen Up/Down Macros 
#####################################################################
[gcode_macro PEN_UP]
description: Lift pen to travel height (3-4mm above drawing surface)
gcode:
    {% set ref_z = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0) %}
    {% if ref_z == 0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL first."
        OLED_MESSAGE MSG="Error: No tool\nreference!"
    {% else %}
        # Calculate drawing surface position
        {% set surface_z = ref_z - printer["gcode_macro PEN_DOWN"].surface_offset|default(10.0) %}
        # Lift 5mm above the drawing surface (not from tool reference)
        {% set travel_z = surface_z + 5 %}
        G90
        G1 Z{travel_z} F1200
        RESPOND TYPE=command MSG="Pen up to travel height Z={travel_z|round(2)}mm (5mm above surface)"
        
        {% if printer.print_stats.state != "printing" %}
            # Get current settings for display
            {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
            {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
            {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
            OLED_MESSAGE MSG="Pen Up\n{mesh_display} mesh\nPressure: L{level}"
        {% endif %}
    {% endif %}

[gcode_macro PEN_DOWN]
description: Lower pen to drawing position with pressure
variable_tool_reference_z: 0.0
variable_surface_offset: 10.0
variable_pressure_offset: 0.05
gcode:
    {% set ref_z = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0) %}
    {% if ref_z == 0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL first."
        OLED_MESSAGE MSG="Error: No tool\nreference!"
    {% else %}
        {% set surface_z = ref_z - printer["gcode_macro PEN_DOWN"].surface_offset %}
        {% set pressure = printer["gcode_macro PEN_DOWN"].pressure_offset|default(0.05) %}
        {% set draw_z = surface_z + pressure %}
        G90
        G1 Z{draw_z} F1200
        RESPOND TYPE=command MSG="Pen down to draw height Z={draw_z|round(2)}mm (pressure offset {pressure|round(2)}mm)"
        
        #{% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
            {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
            {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
            OLED_MESSAGE MSG="Mesh (PD)\n{mesh_display} mesh\nPressure: L{level}"
        #{% endif %}
    {% endif %}

[gcode_macro BLADE_DOWN]
description: Lower pen to drawing position with pressure
variable_tool_reference_z: 0.0
variable_surface_offset: 10.0
variable_pressure_offset: 0.05
gcode:
    {% set ref_z = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0) %}
    {% if ref_z == 0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL first."
        OLED_MESSAGE MSG="Error: No tool\nreference!"
    {% else %}
        {% set surface_z = ref_z - printer["gcode_macro PEN_DOWN"].surface_offset %}
        {% set pressure = printer["gcode_macro PEN_DOWN"].pressure_offset|default(0.05) %}
        {% set draw_z = surface_z + pressure %}
        G90
        G1 Z{draw_z} F400
        RESPOND TYPE=command MSG="Pen down to draw height Z={draw_z|round(2)}mm (pressure offset {pressure|round(2)}mm)"
        
        #{% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
            {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
            {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
            {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
            OLED_MESSAGE MSG="Mesh (PD)\n{mesh_display} mesh\nPressure: L{level}"
        #{% endif %}
    {% endif %}

#####################################################################
# Pressure Level Adjustment
#####################################################################

[gcode_macro SET_PRESSURE_LEVEL]
description: Set pressure level 1-10 (1=lightest +0.25mm, 10=firmest -0.25mm)
variable_current_level: 5
gcode:
    {% set level = params.LEVEL|int|default(5) %}
    {% if level < 1 or level > 10 %}
        RESPOND TYPE=error MSG="Invalid pressure level (must be 1-10). Using Level 5 (+0.05mm)."
        {% set offset = 0.05 %}
        {% set level = 5 %}
    {% else %}
        {% set offset = (6 - level) * 0.05 %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=PEN_DOWN VARIABLE=pressure_offset VALUE={offset}
    SET_GCODE_VARIABLE MACRO=SET_PRESSURE_LEVEL VARIABLE=current_level VALUE={level}
    {% set p_desc = "Level " ~ level ~ ": " ~ offset|round(2) ~ "mm" %}
    
    # Only show OLED message during manual operation (not during tests/prints)
    #{% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
        OLED_MESSAGE MSG="Set\n{p_desc}"
    #{% endif %}
    RESPOND TYPE=command MSG="Pressure set to Level {level} (Offset: {offset|round(2)}mm)"

[gcode_macro CHECK_TOOL_REFERENCE]
description: Display current tool reference, pressure level, and mesh on OLED and terminal
gcode:
    {% set ref_z = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% set offset = printer["gcode_macro PEN_DOWN"].surface_offset|default(10.0) %}
    {% set pressure = printer["gcode_macro PEN_DOWN"].pressure_offset|default(0.05) %}
    {% set surface_z = ref_z - offset %}
    {% set draw_z = surface_z + pressure %}
    {% set travel_z = ref_z + 3.0 %}
    {% set selected = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
    {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
    
    # Detailed terminal output for debugging (always shown)
    RESPOND TYPE=command MSG="=== TOOL REFERENCE & PRESSURE STATUS ==="
    RESPOND TYPE=command MSG="Tool Reference Z: {ref_z|round(2)}mm"
    RESPOND TYPE=command MSG="Surface Offset: {offset}mm"
    RESPOND TYPE=command MSG="Surface Contact Z: {surface_z|round(2)}mm"
    RESPOND TYPE=command MSG="Pressure Offset: {pressure|round(2)}mm"
    RESPOND TYPE=command MSG="Drawing Z: {draw_z|round(2)}mm"
    RESPOND TYPE=command MSG="Travel Height Z: {travel_z|round(2)}mm"
    RESPOND TYPE=command MSG="Current Z: {printer.toolhead.position.z|round(2)}mm"
    RESPOND TYPE=command MSG="Selected Mesh: {selected}"
    RESPOND TYPE=command MSG="Pressure Level: {level}"
    
    # Only show OLED message during manual operation (not during tests/prints)
    {% if printer.print_stats.state == "standby" or printer.print_stats.state == "ready" %}
        OLED_MESSAGE MSG="Mesh: {selected}\nPressure Level: {level}\n(Base is 5)"
    {% endif %}

#####################################################################
# Calibration Macro
#####################################################################

[gcode_macro CAL_FLAT]
description: Calibrate bed surface with automatic mesh range correction
gcode:
    {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}

    OLED_MESSAGE MSG="Starting bed\ncalibration..."
    RESPOND TYPE=command MSG="Starting bed surface calibration..."
    
    # Home and clear any existing mesh
    G28
    BED_MESH_CLEAR
    
    # Generate the mesh with current probe readings
    OLED_MESSAGE MSG="Probing bed\nsurface..."
    BED_MESH_CALIBRATE MESH_MIN=44,6 MESH_MAX=480,506 profile=bed_surface
    
    # Save the corrected mesh
    BED_MESH_PROFILE SAVE=bed_surface

    # Load the new mesh if selected
    {% if selected_mesh == "bed_surface" %}
        BED_MESH_PROFILE LOAD=bed_surface
    {% endif %}

    OLED_MESSAGE MSG="Bed calibration\ncomplete!"
    SAVE_CONFIG
    RESPOND TYPE=command MSG="Bed surface mesh calibrated and saved"

#####################################################################
# Startup Sequence
#####################################################################

[gcode_macro ARIA_STARTUP_SEQUENCE]
description: Startup sequence with working mesh system
gcode:
    RESPOND TYPE=command MSG="Starting Aria Plotter initialization..."
    
    OLED_MESSAGE MSG="Aria Plotter\nInitializing..."
    G4 P1500
    
    OLED_MESSAGE MSG="Checking\nsystems..."
    G4 P1000
    
    OLED_MESSAGE MSG="Homing axes..."
    G28.1
    
    OLED_MESSAGE MSG="Loading bed\nsurface mesh..."
    # Try to load bed surface mesh - if it doesn't exist, user will see error
    {% if 'bed_surface' in printer.bed_mesh.profiles %}
        BED_MESH_PROFILE LOAD=bed_surface
        OLED_MESSAGE MSG="System Ready!\nBed Mesh loaded\nPressure: 5 Base"
    {% else %}
        OLED_MESSAGE MSG="System Ready!\nNo mesh - run\nCAL_FLAT first"
    {% endif %}
    
    M117 Aria Ready
    RESPOND TYPE=command MSG="Aria Plotter ready"

#####################################################################
# Test Print Macros - SIMPLIFIED AND CLEANED
#####################################################################

[gcode_macro TEST_SQUARE]
description: Draw a simple 100mm test square - centered
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        # Calculate centered position for 100mm square
        {% set start_x = 262 - 50 %}     
        {% set start_y = 255 - 50 %}     
        {% set end_x = 262 + 50 %}       
        {% set end_y = 255 + 50 %}       
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: 10x10cm\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_SQUARE"].travel_speed}
        
        OLED_MESSAGE MSG="Drawing 10x10cm\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_SQUARE"].draw_speed}       
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_SQUARE"].draw_speed}         
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_SQUARE"].draw_speed}       
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_SQUARE"].draw_speed}     
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\n10x10cm done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_SQUARE"].travel_speed}    
        M117 Test Complete
        RESPOND TYPE=command MSG="Centered test square complete (100x100mm)"
    {% endif %}

[gcode_macro TEST_EBT]
description: Test print for 8x10 inch canvas (203x254mm) - centered
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        {% set start_x = 160.5 %}  
        {% set start_y = 128 %}    
        {% set end_x = 363.5 %}    
        {% set end_y = 382 %}      
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: 8x10 in\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_EBT"].travel_speed}    
        
        OLED_MESSAGE MSG="Drawing 8x10 in\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_EBT"].draw_speed}      
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_EBT"].draw_speed}        
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_EBT"].draw_speed}      
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_EBT"].draw_speed}    
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\n8x10 in done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_EBT"].travel_speed}   
        M117 EBT Test Complete
        RESPOND TYPE=command MSG="Centered EBT (8x10) test pattern complete"
    {% endif %}

[gcode_macro TEST_NFT]
description: Test print for 9x12 inch canvas (229x305mm) - centered
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        {% set start_x = 147.5 %}  
        {% set start_y = 102.5 %}    
        {% set end_x = 376.5 %}    
        {% set end_y = 407.5 %}      
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: 9x12 in\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_NFT"].travel_speed}    
        
        OLED_MESSAGE MSG="Drawing 9x12 in\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_NFT"].draw_speed}      
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_NFT"].draw_speed}        
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_NFT"].draw_speed}      
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_NFT"].draw_speed}    
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\n9x12 in done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_NFT"].travel_speed}   
        M117 NFT Test Complete
        RESPOND TYPE=command MSG="Centered NFT (9x12) test pattern complete"
    {% endif %}

[gcode_macro TEST_EBF]
description: Test print for 11x14 inch canvas (279x356mm) - centered
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        {% set start_x = 122.5 %}  
        {% set start_y = 77 %}    
        {% set end_x = 401.5 %}    
        {% set end_y = 433 %}      
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: 11x14 in\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_EBF"].travel_speed}    
        
        OLED_MESSAGE MSG="Drawing 11x14 in\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_EBF"].draw_speed}      
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_EBF"].draw_speed}        
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_EBF"].draw_speed}      
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_EBF"].draw_speed}    
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\n11x14 in done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_EBF"].travel_speed}   
        M117 EBF Test Complete
        RESPOND TYPE=command MSG="Centered EBF (11x14) test pattern complete"
    {% endif %}

[gcode_macro TEST_SBT]
description: Test print for 20x16 inch canvas (508x406mm) - centered
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        {% set start_x = 8 %}  
        {% set start_y = 52 %}    
        {% set end_x = 516 %}    
        {% set end_y = 458 %}      
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: 20x16 in\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_SBT"].travel_speed}    
        
        OLED_MESSAGE MSG="Drawing 20x16 in\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_SBT"].draw_speed}      
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_SBT"].draw_speed}        
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_SBT"].draw_speed}      
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_SBT"].draw_speed}    
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\n20x16 in done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_SBT"].travel_speed}   
        M117 SBT Test Complete
        RESPOND TYPE=command MSG="Centered SBT (20x16) test pattern complete"
    {% endif %}

[gcode_macro TEST_FULL]
description: Test print for full bed - outline only
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        {% set start_x = 5 %}  
        {% set start_y = 5 %}    
        {% set end_x = 519 %}    
        {% set end_y = 505 %}      
        {% set center_x = 262 %}
        {% set center_y = 255 %}
        
        OLED_MESSAGE MSG="Test: Full Bed\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_FULL"].travel_speed}    
        
        OLED_MESSAGE MSG="Drawing Full Bed\n{mesh_display} mesh\nPressure: L{level}"
        PEN_DOWN                
        G1 X{end_x} Y{start_y} F{printer["gcode_macro TEST_FULL"].draw_speed}      
        G1 X{end_x} Y{end_y} F{printer["gcode_macro TEST_FULL"].draw_speed}        
        G1 X{start_x} Y{end_y} F{printer["gcode_macro TEST_FULL"].draw_speed}      
        G1 X{start_x} Y{start_y} F{printer["gcode_macro TEST_FULL"].draw_speed}    
        PEN_UP                  
        
        OLED_MESSAGE MSG="Test Complete!\nFull Bed done\nCheck quality"
        G1 X{center_x} Y{center_y} F{printer["gcode_macro TEST_FULL"].travel_speed}   
        M117 Full Bed Test Complete
        RESPOND TYPE=command MSG="Full bed test pattern complete"
    {% endif %}

[gcode_macro TEST_GRID]
description: Draw a grid pattern for testing
variable_draw_speed: 3000      
variable_travel_speed: 6000    
gcode:
    {% set tool_ref = printer["gcode_macro PEN_DOWN"].tool_reference_z|default(0.0) %}
    {% if tool_ref == 0.0 %}
        RESPOND TYPE=error MSG="Tool reference not set! Run LOAD_TOOL and TOOL_INSTALLED first."
        OLED_MESSAGE MSG="Error: Load tool\nfirst!"
        M117 Load Tool First
    {% else %}
        # Get current settings for display
        {% set selected_mesh = printer["gcode_macro MESH_MANAGER"].selected_mesh|default("bed_surface") %}
        {% set level = printer["gcode_macro SET_PRESSURE_LEVEL"].current_level|default(5) %}
        {% set mesh_display = "Bed" if selected_mesh == "bed_surface" else "Canvas" %}
        
        OLED_MESSAGE MSG="Test: Grid\n{mesh_display} mesh\nPressure: L{level}"
        G28                     
        
        OLED_MESSAGE MSG="Drawing Grid\n{mesh_display} mesh\nPressure: L{level}"
        
        # Draw vertical lines every 50mm
        {% for x in range(50, 501, 50) %}
            G1 X{x} Y50 F{printer["gcode_macro TEST_GRID"].travel_speed}
            PEN_DOWN
            G1 X{x} Y450 F{printer["gcode_macro TEST_GRID"].draw_speed}
            PEN_UP
        {% endfor %}
        
        # Draw horizontal lines every 50mm  
        {% for y in range(50, 451, 50) %}
            G1 X50 Y{y} F{printer["gcode_macro TEST_GRID"].travel_speed}
            PEN_DOWN
            G1 X500 Y{y} F{printer["gcode_macro TEST_GRID"].draw_speed}
            PEN_UP
        {% endfor %}
        
        OLED_MESSAGE MSG="Test Complete!\nGrid done\nCheck quality"
        G1 X262 Y255 F{printer["gcode_macro TEST_GRID"].travel_speed}   
        M117 Grid Test Complete
        RESPOND TYPE=command MSG="Grid test pattern complete"
    {% endif %}